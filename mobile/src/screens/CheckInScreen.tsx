import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Alert,
  ActivityIndicator,
  ScrollView,
  Image,
} from 'react-native';
import * as ImagePicker from 'expo-image-picker';
import { useNavigation, NavigationProp } from '@react-navigation/native';
import { visitService } from '../services/visitService';
import { photoService } from '../services/photoService';
import { colors, theme } from '../styles/theme';
import Button from '../components/ui/Button';
import Card from '../components/ui/Card';
import Badge from '../components/ui/Badge';
import { requestForegroundPermissions, getCurrentPosition, LocationObject } from '../utils/locationHelper';

interface Store {
  id: string;
  name: string;
  address: string;
}


type RootStackParamList = {
  ActiveVisit: { visit: any };
};

export default function CheckInScreen({ route }: any) {
  const navigation = useNavigation<NavigationProp<RootStackParamList>>();
  const { store } = route.params || {};
  const [locationPermission, setLocationPermission] = useState<boolean>(false);
  const [location, setLocation] = useState<LocationObject | null>(null);
  const [loading, setLoading] = useState(false);
  const [photoUri, setPhotoUri] = useState<string | null>(null);
  const [showPreview, setShowPreview] = useState(false);
  const [cameraPermission, setCameraPermission] = useState<boolean | null>(null);

  useEffect(() => {
    requestLocationPermission();
    requestCameraPermission();
  }, []);

  async function requestLocationPermission() {
    try {
      const permission = await requestForegroundPermissions();
      setLocationPermission(permission.status === 'granted');
      
      if (permission.status === 'granted') {
        const loc = await getCurrentPosition();
        setLocation(loc);
      } else {
        Alert.alert(
          'Permiss√£o necess√°ria',
          '√â necess√°rio permitir o acesso √† localiza√ß√£o para fazer check-in.',
          [
            { text: 'Cancelar', style: 'cancel' },
            { text: 'Tentar novamente', onPress: requestLocationPermission },
          ]
        );
      }
    } catch (error: any) {
      console.error('Erro ao solicitar permiss√£o de localiza√ß√£o:', error);
      Alert.alert('Erro', error?.message || 'N√£o foi poss√≠vel solicitar permiss√£o de localiza√ß√£o');
    }
  }

  async function requestCameraPermission() {
    try {
      const { status } = await ImagePicker.requestCameraPermissionsAsync();
      setCameraPermission(status === 'granted');
    } catch (error) {
      console.error('Erro ao solicitar permiss√£o de c√¢mera:', error);
      setCameraPermission(false);
    }
  }

  async function takePhoto() {
    try {
      if (cameraPermission === false) {
        const { status } = await ImagePicker.requestCameraPermissionsAsync();
        setCameraPermission(status === 'granted');
        if (status !== 'granted') {
          Alert.alert('Permiss√£o necess√°ria', '√â necess√°rio permitir o acesso √† c√¢mera');
          return;
        }
      }

      const result = await ImagePicker.launchCameraAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.8,
        allowsEditing: false,
      });

      if (!result.canceled && result.assets[0]) {
        setPhotoUri(result.assets[0].uri);
        setShowPreview(true);
      }
    } catch (error) {
      console.error('Erro ao capturar foto:', error);
      Alert.alert('Erro', 'N√£o foi poss√≠vel capturar a foto');
    }
  }

  async function handleCheckIn() {
    if (!store) {
      Alert.alert('Erro', 'Selecione uma loja primeiro');
      return;
    }

    if (!location) {
      Alert.alert('Erro', 'N√£o foi poss√≠vel obter a localiza√ß√£o');
      return;
    }

    if (!photoUri) {
      Alert.alert('Erro', 'Tire uma foto da fachada primeiro');
      return;
    }

    setLoading(true);
    try {
      console.log('üì∏ [CheckIn] Iniciando processo de check-in...');
      console.log('üì∏ [CheckIn] Store ID:', store.id);
      console.log('üì∏ [CheckIn] Location:', location.coords);
      console.log('üì∏ [CheckIn] Photo URI:', photoUri);

      // 1. Fazer check-in primeiro para obter visitId real
      // Usaremos uma URL tempor√°ria que ser√° substitu√≠da
      console.log('üì∏ [CheckIn] Criando visita para obter visitId...');
      const tempPhotoUrl = 'https://placeholder.com/checkin.jpg';
      
      const checkInResult = await visitService.checkIn({
        storeId: store.id,
        latitude: location.coords.latitude,
        longitude: location.coords.longitude,
        photoUrl: tempPhotoUrl, // Tempor√°ria, ser√° substitu√≠da
      });

      const visitId = checkInResult.visit?.id;
      if (!visitId) {
        throw new Error('N√£o foi poss√≠vel obter o ID da visita');
      }

      console.log('‚úÖ [CheckIn] Visita criada, visitId:', visitId);

      // 2. Agora que temos o visitId real, fazer upload da foto
      console.log('üì∏ [CheckIn] Obtendo presigned URL com visitId real...');
      let photoUrl = '';
      
      try {
        const { presignedUrl, url } = await photoService.getPresignedUrl({
          visitId: visitId,
          type: 'FACADE_CHECKIN',
          contentType: 'image/jpeg',
          extension: 'jpg',
        });

        console.log('üì∏ [CheckIn] Presigned URL obtida:', presignedUrl ? 'Sim' : 'N√£o');
        console.log('üì∏ [CheckIn] URL final:', url);

        // 3. Upload da foto para Firebase Storage
        if (presignedUrl && photoUri) {
          console.log('üì∏ [CheckIn] Fazendo upload da foto...');
          const uploadSuccess = await photoService.uploadToS3(presignedUrl, photoUri, 'image/jpeg');
          
          if (uploadSuccess) {
            console.log('‚úÖ [CheckIn] Upload da foto conclu√≠do com sucesso');
            photoUrl = url; // URL p√∫blica do Firebase
          } else {
            console.error('‚ùå [CheckIn] Upload da foto falhou');
            throw new Error('Falha no upload da foto');
          }
        } else {
          throw new Error('Presigned URL ou photoUri n√£o dispon√≠vel');
        }
      } catch (uploadError: any) {
        console.error('‚ùå [CheckIn] Erro no upload da foto:', uploadError);
        // Continuar mesmo se o upload falhar - a visita j√° foi criada
        console.warn('‚ö†Ô∏è [CheckIn] Visita criada, mas upload da foto falhou');
        photoUrl = tempPhotoUrl; // Manter URL tempor√°ria
      }

      // 4. Atualizar o registro da foto com a URL correta
      if (photoUrl && photoUrl !== tempPhotoUrl) {
        console.log('üì∏ [CheckIn] Atualizando registro da foto com URL correta...');
        try {
          // Usar uploadPhotos para atualizar/criar o registro correto
          // O PhotoGallery prioriza photos[] sobre checkInPhotoUrl
          await visitService.uploadPhotos({
            visitId: visitId,
            photos: [{
              url: photoUrl,
              type: 'FACADE_CHECKIN',
              latitude: location.coords.latitude,
              longitude: location.coords.longitude,
            }],
          });
          console.log('‚úÖ [CheckIn] Registro da foto atualizado');
        } catch (updateError: any) {
          console.warn('‚ö†Ô∏è [CheckIn] Erro ao atualizar registro da foto:', updateError);
          // Continuar mesmo se falhar - a foto j√° est√° no Firebase
        }
      }

      const result = checkInResult;
      console.log('‚úÖ [CheckIn] Check-in realizado com sucesso:', result);

      Alert.alert('‚úÖ Sucesso', 'Check-in realizado com sucesso!', [
        {
          text: 'OK',
          onPress: () => {
            navigation.navigate('ActiveVisit', { visit: result.visit });
          },
        },
      ]);
    } catch (error: any) {
      console.error('‚ùå [CheckIn] Erro no check-in:', error);
      console.error('‚ùå [CheckIn] Tipo do erro:', error?.constructor?.name);
      console.error('‚ùå [CheckIn] Mensagem:', error?.message);
      console.error('‚ùå [CheckIn] Response:', error?.response?.data);
      console.error('‚ùå [CheckIn] Status:', error?.response?.status);
      console.error('‚ùå [CheckIn] Stack:', error?.stack);
      
      const errorMessage = 
        error?.response?.data?.message || 
        error?.message || 
        'Erro ao fazer check-in. Verifique sua conex√£o e tente novamente.';
      
      Alert.alert('Erro', errorMessage);
    } finally {
      setLoading(false);
    }
  }

  if (cameraPermission === null) {
    return (
      <View style={styles.container}>
        <ActivityIndicator size="large" color={colors.primary[600]} />
      </View>
    );
  }

  if (cameraPermission === false) {
    return (
      <View style={styles.container}>
        <Card style={styles.permissionCard}>
          <Text style={styles.permissionIcon}>üì∑</Text>
          <Text style={styles.permissionTitle}>Permiss√£o de C√¢mera Necess√°ria</Text>
          <Text style={styles.permissionText}>
            Precisamos do acesso √† c√¢mera para tirar fotos da fachada das lojas.
          </Text>
          <Button variant="primary" size="lg" onPress={requestCameraPermission} style={styles.permissionButton}>
            Permitir C√¢mera
          </Button>
        </Card>
      </View>
    );
  }

  return (
    <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.title}>Check-in</Text>
        <Text style={styles.subtitle}>Tire uma foto da fachada da loja</Text>
      </View>

      {/* Informa√ß√µes da Loja */}
      {store && (
        <Card style={styles.storeCard} shadow>
          <View style={styles.storeHeader}>
            <View style={styles.storeIcon}>
              <Text style={styles.storeIconText}>üè™</Text>
            </View>
            <View style={styles.storeInfo}>
              <Text style={styles.storeName}>{store.name}</Text>
              <Text style={styles.storeAddress}>{store.address}</Text>
            </View>
          </View>
        </Card>
      )}

      {/* Preview da Foto ou C√¢mera */}
      {showPreview && photoUri ? (
        <Card style={styles.previewCard} shadow>
          <View style={styles.previewHeader}>
            <Text style={styles.previewTitle}>Preview da Foto</Text>
            <TouchableOpacity
              onPress={() => {
                setPhotoUri(null);
                setShowPreview(false);
              }}
              style={styles.closeButton}
            >
              <Text style={styles.closeButtonText}>‚úï</Text>
            </TouchableOpacity>
          </View>
          <Image source={{ uri: photoUri }} style={styles.previewImage} />
          <View style={styles.previewActions}>
            <Button
              variant="outline"
              size="md"
              onPress={() => {
                setPhotoUri(null);
                setShowPreview(false);
              }}
              style={styles.previewButton}
            >
              Tirar Outra
            </Button>
          </View>
        </Card>
      ) : (
        <Card style={styles.cameraCard} shadow>
          <View style={styles.cameraPlaceholder}>
            <Text style={styles.cameraIcon}>üì∑</Text>
            <Text style={styles.cameraText}>Pronto para tirar foto</Text>
          </View>
        </Card>
      )}

      {/* Status de Localiza√ß√£o */}
      <Card style={styles.statusCard} shadow>
        <View style={styles.statusRow}>
          <View style={styles.statusItem}>
            <View
              style={[
                styles.statusIndicator,
                location ? styles.statusIndicatorActive : undefined,
              ]}
            >
              <Text style={styles.statusIcon}>{location ? '‚úì' : '‚óã'}</Text>
            </View>
            <View style={styles.statusInfo}>
              <Text style={styles.statusLabel}>Localiza√ß√£o</Text>
              <Text style={styles.statusValue}>
                {location
                  ? `${location.coords.latitude.toFixed(4)}, ${location.coords.longitude.toFixed(4)}`
                  : 'Obtendo...'}
              </Text>
            </View>
          </View>
          <View style={styles.statusItem}>
            <View
              style={[
                styles.statusIndicator,
                photoUri ? styles.statusIndicatorActive : undefined,
              ]}
            >
              <Text style={styles.statusIcon}>{photoUri ? '‚úì' : '‚óã'}</Text>
            </View>
            <View style={styles.statusInfo}>
              <Text style={styles.statusLabel}>Foto</Text>
              <Text style={styles.statusValue}>{photoUri ? 'Capturada' : 'Pendente'}</Text>
            </View>
          </View>
        </View>
      </Card>

      {/* A√ß√µes */}
      <View style={styles.actions}>
        {!showPreview && (
          <Button
            variant="accent"
            size="lg"
            onPress={takePhoto}
            disabled={loading}
            style={styles.actionButton}
          >
            üì∑ Tirar Foto
          </Button>
        )}
        <Button
          variant="primary"
          size="lg"
          onPress={handleCheckIn}
          isLoading={loading}
          disabled={!photoUri || !location || loading}
          style={styles.actionButton}
        >
          ‚úÖ Fazer Check-in
        </Button>
      </View>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.dark.background,
  },
  contentContainer: {
    padding: theme.spacing.lg,
  },
  header: {
    marginBottom: theme.spacing.xl,
  },
  title: {
    fontSize: theme.typography.fontSize['3xl'],
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  subtitle: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
  },
  storeCard: {
    marginBottom: theme.spacing.lg,
  },
  storeHeader: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  storeIcon: {
    width: 50,
    height: 50,
    borderRadius: theme.borderRadius.full,
    backgroundColor: 'rgba(124, 58, 237, 0.2)',
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: theme.spacing.md,
  },
  storeIconText: {
    fontSize: 24,
  },
  storeInfo: {
    flex: 1,
  },
  storeName: {
    fontSize: theme.typography.fontSize.lg,
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  storeAddress: {
    fontSize: theme.typography.fontSize.sm,
    color: colors.text.secondary,
  },
  cameraCard: {
    marginBottom: theme.spacing.lg,
    minHeight: 200,
  },
  cameraPlaceholder: {
    height: 200,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: colors.dark.card,
    borderRadius: theme.borderRadius.lg,
  },
  cameraIcon: {
    fontSize: 48,
    marginBottom: theme.spacing.md,
  },
  cameraText: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
  },
  previewCard: {
    marginBottom: theme.spacing.lg,
  },
  previewHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: theme.spacing.md,
  },
  previewTitle: {
    fontSize: theme.typography.fontSize.lg,
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
  },
  closeButton: {
    width: 32,
    height: 32,
    borderRadius: theme.borderRadius.full,
    backgroundColor: colors.dark.card,
    justifyContent: 'center',
    alignItems: 'center',
  },
  closeButtonText: {
    fontSize: 18,
    color: colors.text.secondary,
  },
  previewImage: {
    width: '100%',
    height: 300,
    borderRadius: theme.borderRadius.lg,
    marginBottom: theme.spacing.md,
  },
  previewActions: {
    flexDirection: 'row',
    gap: theme.spacing.md,
  },
  previewButton: {
    flex: 1,
  },
  statusCard: {
    marginBottom: theme.spacing.lg,
  },
  statusRow: {
    gap: theme.spacing.md,
  },
  statusItem: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  statusIndicator: {
    width: 40,
    height: 40,
    borderRadius: theme.borderRadius.full,
    backgroundColor: colors.dark.card,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: theme.spacing.md,
  },
  statusIndicatorActive: {
    backgroundColor: 'rgba(34, 197, 94, 0.2)',
  },
  statusIcon: {
    fontSize: 20,
    fontWeight: theme.typography.fontWeight.bold,
  },
  statusInfo: {
    flex: 1,
  },
  statusLabel: {
    fontSize: theme.typography.fontSize.xs,
    color: colors.text.tertiary,
    marginBottom: theme.spacing.xs,
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  statusValue: {
    fontSize: theme.typography.fontSize.sm,
    fontWeight: theme.typography.fontWeight.medium,
    color: colors.text.primary,
  },
  actions: {
    gap: theme.spacing.md,
    marginTop: theme.spacing.md,
  },
  actionButton: {
    width: '100%',
  },
  permissionCard: {
    margin: theme.spacing.xl,
    alignItems: 'center',
    padding: theme.spacing.xl,
  },
  permissionIcon: {
    fontSize: 64,
    marginBottom: theme.spacing.lg,
  },
  permissionTitle: {
    fontSize: theme.typography.fontSize['2xl'],
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.md,
    textAlign: 'center',
  },
  permissionText: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
    textAlign: 'center',
    marginBottom: theme.spacing.xl,
    lineHeight: 22,
  },
  permissionButton: {
    width: '100%',
  },
});
